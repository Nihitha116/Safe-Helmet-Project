<!--
SafeHelmet+ ‚Ä¢ Safety Companion
Single-file demo (HTML + embedded CSS + JS)

How to split into separate files:
- save the <style> contents into safe-helmet.css
- save the <script> contents into safe-helmet.js
- keep the HTML and link the CSS/JS files from <head> and before </body>

Notes:
- Geolocation requires HTTPS (or localhost).
- Sending SMS/WhatsApp is performed by opening the respective URL schemes ‚Äî this works best on mobile devices.
- WhatsApp: use international phone number without +, e.g. 919812345678 for India.
- SMS: browser support varies on desktop.
- Always test on a real phone for full functionality.
-->

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SafeHelmet+ ‚Ä¢ Safety Companion</title>
  <style>
    :root{--bg:#0f172a;--card:#0b1220;--accent:#06b6d4;--muted:#94a3b8;--danger:#ef4444}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;color:#e6eef6;background:linear-gradient(180deg,#021021 0%, #042233 100%)}
    .app{max-width:980px;margin:28px auto;padding:20px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));box-shadow:0 8px 30px rgba(2,6,23,0.6)}
    header{display:flex;gap:12px;align-items:center}
    header h1{font-size:20px;margin:0}
    .grid{display:grid;grid-template-columns:1fr 320px;gap:18px;margin-top:18px}

    .card{background:var(--card);padding:16px;border-radius:12px;color:#dff6fb}
    .controls{display:flex;flex-direction:column;gap:12px}
    label{font-size:13px;color:var(--muted)}
    input[type=text], input[type=tel]{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    button{padding:12px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:600}
    .btn-sos{background:linear-gradient(90deg,#ef4444,#f97316);color:white;box-shadow:0 6px 18px rgba(239,68,68,0.18)}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .status{font-size:13px;color:var(--muted)}

    .map-preview{height:220px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.00));display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:14px}

    .telemetry{display:flex;gap:10px;flex-wrap:wrap}
    .stat{background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;min-width:120px}

    footer{margin-top:14px;font-size:12px;color:var(--muted)}

    @media(max-width:880px){.grid{grid-template-columns:1fr;}.map-preview{height:180px}}
  </style>
</head>
<body>
  <div class="app card">
    <header>
      <div style="width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#0ea5a4);display:flex;align-items:center;justify-content:center;font-weight:700;color:#021022">SH</div>
      <div>
        <h1>SafeHelmet+ ‚Ä¢ Safety Companion</h1>
        <div class="status">Helmet-connected ¬∑ GPS ready (HTTPS required) ¬∑ Mobile-friendly</div>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <h3 style="margin-top:0">Quick SOS</h3>
        <p class="status">Press SOS to send your current location to your emergency contact via WhatsApp and SMS (opens app/tabs).</p>

        <div class="controls" style="margin-top:8px">
          <label>Emergency contact (WhatsApp / SMS) ‚Äî international format</label>
          <input id="contactNumber" type="tel" placeholder="e.g. 919812345678 (India)" />

          <label>Optional message</label>
          <input id="customMsg" type="text" placeholder="I'm in emergency ‚Äî please help!" />

          <div style="display:flex;gap:8px;align-items:center">
            <button id="sosBtn" class="btn-sos">üö® SEND SOS</button>
            <button id="getLocBtn" class="btn-ghost">üìç Get Location</button>
            <button id="copyBtn" class="btn-ghost">üìã Copy Message</button>
          </div>

          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="waBtn" class="btn-ghost">WhatsApp (preview)</button>
            <button id="smsBtn" class="btn-ghost">SMS (preview)</button>
          </div>

          <div style="margin-top:8px" class="status">Last known: <span id="lastKnown">‚Äî</span></div>
        </div>

        <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)" />

        <h4 style="margin:6px 0">Helmet telemetry</h4>
        <div class="telemetry">
          <div class="stat">Battery: <strong id="battery">95%</strong></div>
          <div class="stat">Impact: <strong id="impact">No</strong></div>
          <div class="stat">Speed: <strong id="speed">0 km/h</strong></div>
          <div class="stat">Tracking: <strong id="tracking">Off</strong></div>
        </div>

        <div style="display:flex;gap:8px;margin-top:12px;align-items:center">
          <button id="trackToggle" class="btn-ghost">Start Tracking</button>
          <button id="simulateImpact" class="btn-ghost">Simulate Impact</button>
        </div>

      </section>

      <aside class="card">
        <h3 style="margin-top:0">Map preview</h3>
        <div id="map" class="map-preview">No location yet ‚Äî press Get Location</div>

        <h4 style="margin-top:12px">Message preview</h4>
        <div style="background:rgba(0,0,0,0.25);padding:10px;border-radius:8px;min-height:70px;color:var(--muted)" id="msgPreview">‚Äî</div>

        <footer>Note: This is a demo. For production, add server auth, SOS escalation, and verified contacts.</footer>
      </aside>
    </div>
  </div>

  <script>
    // ===== SafeHelmet+ ‚Ä¢ Demo JS =====
    // Requirements:
    // - Served over HTTPS or on localhost for geolocation to work
    // - On mobile devices: WhatsApp and SMS schemes will open the apps

    const contactInput = document.getElementById('contactNumber');
    const customMsgInput = document.getElementById('customMsg');
    const sosBtn = document.getElementById('sosBtn');
    const getLocBtn = document.getElementById('getLocBtn');
    const waBtn = document.getElementById('waBtn');
    const smsBtn = document.getElementById('smsBtn');
    const copyBtn = document.getElementById('copyBtn');
    const lastKnown = document.getElementById('lastKnown');
    const mapDiv = document.getElementById('map');
    const msgPreview = document.getElementById('msgPreview');
    const trackToggle = document.getElementById('trackToggle');
    const simulateImpact = document.getElementById('simulateImpact');

    let lastPosition = null;
    let watchId = null;
    let tracking = false;
    let impactDetected = false;

    function setStatusText(txt){ document.getElementById('lastKnown').textContent = txt }

    function updateTelemetry(){
      document.getElementById('battery').textContent = '95%';
      document.getElementById('impact').textContent = impactDetected ? 'Yes' : 'No';
      document.getElementById('speed').textContent = lastPosition && lastPosition.coords.speed ? `${(lastPosition.coords.speed*3.6).toFixed(1)} km/h` : '0 km/h';
      document.getElementById('tracking').textContent = tracking ? 'On' : 'Off';
    }

    function buildMessage(position){
      const lat = position.coords.latitude.toFixed(6);
      const lng = position.coords.longitude.toFixed(6);
      const maps = `https://maps.google.com/?q=${lat},${lng}`;
      const custom = customMsgInput.value.trim() || "I'm in an emergency ‚Äî please help!";
      const time = new Date(position.timestamp).toLocaleString();
      return `${custom}\n\nI'm at: ${lat}, ${lng}\n${maps}\nTime: ${time}`;
    }

    function showMapPreview(position){
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;
      // show a small static map link preview
      mapDiv.innerHTML = `\n        <div style=\"width:100%;height:100%;display:flex;flex-direction:column;gap:8px;align-items:center;justify-content:center\">\n          <div style=\"font-size:13px;color:var(--muted)\">Latitude: ${lat.toFixed(6)} ¬∑ Longitude: ${lng.toFixed(6)}</div>\n          <a target=\"_blank\" rel=\"noopener\" href=\"https://maps.google.com/?q=${lat},${lng}\">Open in Google Maps</a>\n        </div>\n      `;
    }

    function safeGetLocation(){
      return new Promise((resolve,reject)=>{
        if(!navigator.geolocation){
          reject(new Error('Geolocation not supported'));
          return;
        }
        navigator.geolocation.getCurrentPosition(pos=>resolve(pos), err=>reject(err), {enableHighAccuracy:true,timeout:10000});
      });
    }

    async function handleGetLocation(){
      try{
        const pos = await safeGetLocation();
        lastPosition = pos;
        setStatusText(`${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)}`);
        updateTelemetry();
        showMapPreview(pos);
        msgPreview.textContent = buildMessage(pos);
      }catch(err){
        alert('Failed to get location: ' + err.message + '\nEnsure the page is served over HTTPS and that you allowed location access.');
      }
    }

    function sendWhatsAppMessage(number, message){
      // number is optional. If provided, it should be without + and only digits (international format)
      const encoded = encodeURIComponent(message);
      let url = '';
      if(number && number.trim()){
        // Open chat with specific number
        const n = number.replace(/[^0-9]/g,'');
        url = `https://wa.me/${n}?text=${encoded}`; // opens chat with number
      }else{
        // Open WhatsApp with message prefilled and ask user to choose contact
        url = `https://wa.me/?text=${encoded}`;
      }
      window.open(url, '_blank');
    }

    function sendSMS(number, message){
      const encoded = encodeURIComponent(message);
      if(number && number.trim()){
        // Modern browsers: sms: number?body=message
        const n = number.replace(/[^0-9+]/g,'');
        const url = `sms:${n}?body=${encoded}`;
        window.open(url, '_self');
      }else{
        // open SMS app without number
        const url = `sms:?body=${encoded}`;
        window.open(url, '_self');
      }
    }

    function copyToClipboard(text){
      if(navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(text).then(()=>{
          alert('Message copied to clipboard ‚Äî paste in any app to send.');
        }).catch(()=>{
          fallbackCopy(text);
        });
      }else fallbackCopy(text);
    }
    function fallbackCopy(text){
      const ta = document.createElement('textarea');ta.value=text;document.body.appendChild(ta);ta.select();try{document.execCommand('copy');alert('Message copied to clipboard.');}catch(e){prompt('Copy the text below', text);}ta.remove();
    }

    async function sendSOS(){
      sosBtn.disabled = true; sosBtn.textContent = 'Sending...';
      try{
        const pos = await safeGetLocation();
        lastPosition = pos; updateTelemetry(); showMapPreview(pos);
        const msg = buildMessage(pos);
        msgPreview.textContent = msg;
        const contact = contactInput.value.trim();
        // Try both WhatsApp and SMS
        // IMPORTANT: these open apps/tabs; don't rely on them returning success.
        // First open WhatsApp in a new tab
        sendWhatsAppMessage(contact, msg);
        // Then attempt SMS (mobile only)
        setTimeout(()=>{
          try{ sendSMS(contact, msg); }catch(e){ console.warn('SMS open failed', e); }
        }, 700);

        // As a fallback, copy message so user can paste into any app
        copyToClipboard(msg);

      }catch(err){
        alert('Could not fetch GPS location: ' + err.message + '\nMake sure you allowed location access and are on HTTPS.');
      }finally{
        sosBtn.disabled = false; sosBtn.textContent = 'üö® SEND SOS';
      }
    }

    // Tracking (watchPosition)
    function startTracking(){
      if(!navigator.geolocation){ alert('Geolocation not supported'); return; }
      watchId = navigator.geolocation.watchPosition(pos=>{
        lastPosition = pos; setStatusText(`${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)}`);
        updateTelemetry(); showMapPreview(pos); msgPreview.textContent = buildMessage(pos);
        // Auto send if impact was detected
        if(impactDetected){
          // small throttle: only send once per impact
          impactDetected = false;
          sendSOS();
        }
      }, err=>{
        console.warn('watch failed', err);
      }, {enableHighAccuracy:true, maximumAge:2000, timeout:10000});
      tracking = true; updateTelemetry(); trackToggle.textContent = 'Stop Tracking';
    }
    function stopTracking(){
      if(watchId !== null){ navigator.geolocation.clearWatch(watchId); watchId = null; }
      tracking = false; updateTelemetry(); trackToggle.textContent = 'Start Tracking';
    }

    // Simulate impact detection from helmet sensor
    function simulateImpactDetected(){
      impactDetected = true;
      alert('Impact simulated. App will auto-send SOS when next GPS fix is obtained.');
      // If we have a last position now, trigger immediate send
      if(lastPosition){ sendSOS(); }
    }

    // Event listeners
    getLocBtn.addEventListener('click', handleGetLocation);
    sosBtn.addEventListener('click', sendSOS);
    waBtn.addEventListener('click', async()=>{
      try{ const pos = lastPosition || await safeGetLocation(); const msg = buildMessage(pos); sendWhatsAppMessage(contactInput.value.trim(), msg); }catch(e){ alert('No location yet. Press Get Location first or allow location access.'); }
    });
    smsBtn.addEventListener('click', async()=>{
      try{ const pos = lastPosition || await safeGetLocation(); const msg = buildMessage(pos); sendSMS(contactInput.value.trim(), msg); }catch(e){ alert('No location yet. Press Get Location first or allow location access.'); }
    });
    copyBtn.addEventListener('click', ()=>{ if(lastPosition) copyToClipboard(buildMessage(lastPosition)); else alert('No location to copy yet.'); });

    trackToggle.addEventListener('click', ()=>{
      if(tracking) stopTracking(); else startTracking();
    });
    simulateImpact.addEventListener('click', simulateImpactDetected);

    // Initial state
    updateTelemetry();
  </script>
</body>
</html>
